<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RLC Coach App - Version 7</title>

  <!-- Lato Font from Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" />

  <style>
    /* BRAND & BASE STYLES */
    :root {
      --brand-blue: #1167BE;
      --brand-orange: #FF9A04;
      --brand-text: #333333;
      --brand-bg: #F5F7FA;
      --brand-white: #FFFFFF;
      --sidebar-width: 250px;
    }

    body {
      font-family: 'Lato', sans-serif;
      color: var(--brand-text);
      background-color: var(--brand-bg);
      margin: 0;
      padding: 0;
      display: flex;
      transition: 0.3s;
    }

    /* SIDEBAR */
    #sidebar {
      width: var(--sidebar-width);
      background: var(--brand-blue);
      color: var(--brand-white);
      height: 100vh;
      padding: 20px;
      position: relative;
      transition: transform 0.3s ease;
    }

    /* Hamburger button (for small screens) */
    #hamburger-btn {
      display: none;
      background: none;
      border: none;
      color: var(--brand-white);
      font-size: 1.5rem;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    #sidebar h2 {
      margin: 0 0 1rem 0;
      font-weight: 700;
      color: var(--brand-white);
    }

    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sidebar ul li {
      padding: 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    #sidebar ul li:hover {
      background: var(--brand-orange);
    }
    /* Divider line in the sidebar menu */
    .divider {
      border-top: 1px solid #fff;
      margin: 10px 0;
      padding: 0;
      cursor: default;
    }

    /* MAIN CONTENT */
    #content {
      flex: 1;
      padding: 20px;
      transition: 0.3s;
    }
    .hidden {
      display: none;
    }

    /* Collapsible sidebar on small screens */
    @media (max-width: 768px) {
      #sidebar {
        position: absolute;
        top: 0; left: 0;
        transform: translateX(-100%);
        z-index: 999;
      }
      #sidebar.open {
        transform: translateX(0);
      }
      #hamburger-btn {
        display: inline-block;
      }
    }

    /***************************************************
     * HEADINGS
     ***************************************************/
    h1, h2, h3, h4 {
      font-weight: 700;
      color: var(--brand-blue);
      margin-top: 0.5rem;
    }

    /***************************************************
     * INTRODUCTION (3-column layout)
     ***************************************************/
    .intro-layout {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .chapters-column, .carousel-column, .chat-column {
      background: var(--brand-white);
      border: 1px solid #ddd;
      padding: 10px;
      box-sizing: border-box;
      border-radius: 4px;
    }
    .chapters-column {
      flex: 0 0 20%;
      min-width: 200px;
    }
    .carousel-column {
      flex: 1;
      min-width: 300px;
      position: relative;
    }
    .chat-column {
      flex: 0 0 20%;
      min-width: 200px;
    }
    .slide-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      bottom: 10px;
      width: 95%;
      padding: 0 10px;
    }
    .slide-indicators {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    .slide-indicators span {
      width: 12px;
      height: 12px;
      margin: 0 5px;
      background: #ccc;
      border-radius: 50%;
      cursor: pointer;
    }
    .slide-indicators .active {
      background: var(--brand-orange);
    }
    #slide-info {
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--brand-text);
    }

    /***************************************************
     * AI COACH (chat-like interface)
     ***************************************************/
    .ai-coach-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .ai-coach-card {
      max-width: 700px;
      width: 100%;
      background: var(--brand-white);
      border: 1px solid #ddd;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 140px);
      padding: 10px;
      border-radius: 4px;
    }
    .coach-messages {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .coach-input-area {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .coach-input-area textarea {
      flex: 1;
      resize: none;
      border-radius: 4px;
    }
    .coach-voice-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--brand-blue);
    }
    .coach-voice-btn::after {
      content: '\\1F3A4';
    }

    /***************************************************
     * PROJECT PLAN (Board/Flow)
     ***************************************************/
    .toggle-view {
      margin-bottom: 10px;
    }
    .board-container {
      display: flex;
      gap: 20px;
    }
    .ie-column {
      background: var(--brand-white);
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
      padding: 10px;
      min-height: 300px;
    }
    .kd-card {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px;
      margin: 4px 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .kd-card .pencil {
      font-size: 1rem;
      color: #666;
      margin-left: 8px;
    }
    .kd-card:hover .pencil {
      color: var(--brand-orange);
    }
    .add-kd-btn {
      margin-top: 10px;
      width: 100%;
      background: var(--brand-orange);
      color: var(--brand-white);
      border: none;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .diagram-container {
      position: relative;
      width: 100%;
      min-height: 400px;
      background: var(--brand-white);
      border: 1px solid #ddd;
      margin-top: 20px;
      overflow: scroll;
      border-radius: 4px;
      transform: scale(0.9);
      transform-origin: top left;
    }
    .ie-node {
      position: absolute;
      width: 180px;
      min-height: 80px;
      background: #f0f0f0;
      border: 2px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
    }
    .kd-list {
      margin-top: 10px;
      text-align: left;
    }
    .kd-item {
      background: #fff;
      margin: 2px 0;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .diagram-line {
      position: absolute;
      width: 2px;
      background: #333;
      z-index: 1;
    }

    /***************************************************
     * ARCHIVE
     ***************************************************/
    .folder {
      cursor: pointer;
      font-weight: bold;
    }
    .file {
      margin-left: 20px;
      cursor: pointer;
    }

    /***************************************************
     * SIDE DRAWER (KDs)
     ***************************************************/
    .side-drawer {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: var(--brand-white);
      box-shadow: -2px 0 6px rgba(0, 0, 0, 0.2);
      padding: 20px;
      transition: right 0.3s ease;
      overflow-y: auto;
      z-index: 999;
    }
    .side-drawer.open {
      right: 0;
    }
    .side-drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .side-drawer-header h3 {
      margin: 0;
      color: var(--brand-blue);
    }
    .close-btn {
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 5px 8px;
      cursor: pointer;
      border-radius: 4px;
    }
    .drawer-field {
      margin-top: 10px;
    }
    .drawer-field label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--brand-text);
    }
    .drawer-field input,
    .drawer-field textarea {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .kg-list {
      border: 1px solid #ddd;
      margin-top: 10px;
      padding: 6px;
      border-radius: 4px;
    }
    .kg-item {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin: 4px 0;
      padding: 4px 6px;
      cursor: pointer;
    }

    /***************************************************
     * REPORT WRITER (KD/KG dynamic layout)
     ***************************************************/
    .report-layout {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      height: calc(100vh - 200px);
    }
    .report-chat {
      flex: 0.3;
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      background: var(--brand-white);
      box-sizing: border-box;
      padding: 10px;
      border-radius: 4px;
    }
    .chat-messages {
      flex: 1; 
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .chat-input-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-input-area textarea {
      flex: 1;
      resize: none;
      border-radius: 4px;
    }
    .report-preview {
      flex: 0.7;
      border: 1px solid #ddd;
      background: var(--brand-white);
      padding: 10px;
      box-sizing: border-box;
      position: relative;
      overflow-y: auto;
      border-radius: 4px;
    }
    .report-buttons {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .voice-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--brand-blue);
    }
    .voice-btn::after {
      content: '\\1F3A4';
    }
    .template-grid {
      display: grid;
      grid-template-columns: 2fr 2fr;
      grid-template-rows: auto auto auto auto;
      gap: 10px;
      margin-top: 10px;
    }
    .banner-left, .banner-right {
      border: 1px solid #ccc;
      padding: 10px;
      background: #fffa97;
      border-radius: 4px;
    }
    .banner-left-kd, .banner-right-kd {
      background: #b3ff9f;
    }
    .template-box {
      border: 1px solid #ccc;
      padding: 10px;
      background: var(--brand-white);
      min-height: 80px;
      border-radius: 4px;
    }
    .template-box textarea {
      width: 100%;
      height: 60px;
      resize: vertical;
      border-radius: 4px;
    }
    .template-large {
      min-height: 150px;
    }

    /***************************************************
     * BASIC ACCESSIBILITY
     ***************************************************/
    button, input, textarea, select {
      font-family: 'Lato', sans-serif;
      font-size: 0.95rem;
    }
    button:focus,
    input:focus,
    textarea:focus,
    select:focus {
      outline: 2px solid var(--brand-orange);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <!-- HAMBURGER for small screens -->
  <button id="hamburger-btn" aria-label="Toggle sidebar" onclick="toggleSidebar()">&#9776;</button>

  <!-- SIDEBAR -->
  <div id="sidebar">
    <h2>Rapid Learning Cycles Project Assistant</h2>
    <ul>
      <!-- Project-agnostic sections -->
      <li onclick="showSection('introduction')">Introduction to RLC</li>
      <li onclick="showSection('ai_coach')">AI Coach</li>
      
      <!-- Divider and Project Selector -->
      <li class="divider"></li>
      <li style="cursor: default;">
        <label for="project-selector" style="display:block; margin-bottom:5px;">Select Project:</label>
        <select id="project-selector" onchange="handleProjectSelect()" style="width:90%;">
          <option value="">--Choose a Project--</option>
        </select>
      </li>
      
      <!-- Project-specific sections -->
      <li onclick="showSection('core_hypothesis')">Core Hypothesis Guide</li>
      <li onclick="showSection('project_plan')">Project Schedule</li>
      <li onclick="showSection('report_writer')">Report Writer</li>
      <li onclick="showSection('archive')">Archive</li>
      
      <!-- Divider before Admin sections -->
      <li class="divider"></li>
      <!-- Admin Sections -->
      <li onclick="showSection('project_admin')">Project Admin</li>
      <li onclick="showSection('account_admin')">Account Admin</li>
    </ul>
  </div>

  <!-- MAIN CONTENT -->
  <div id="content">
    <!-- INTRODUCTION SECTION -->
    <div id="introduction" class="section hidden">
      <h2>Introduction to RLC</h2>
      <p>Learn about Rapid Learning Cycles through the following chapters:</p>
      <div class="intro-layout">
        <div class="chapters-column">
          <h3>Chapters</h3>
          <ul id="chapter-list" style="list-style: none; padding: 0;">
            <li onclick="showChapter('Overview')">Overview</li>
            <li onclick="showChapter('Kick-off Event')">Kick-off Event</li>
            <li onclick="showChapter('Core Hypothesis')">Core Hypothesis</li>
            <li onclick="showChapter('Learning Cycle Plan')">Learning Cycle Plan</li>
            <li onclick="showChapter('Key Decisions')">Key Decisions</li>
            <li onclick="showChapter('Knowledge Gaps')">Knowledge Gaps</li>
            <li onclick="showChapter('Status Meetings')">Status Meetings</li>
          </ul>
        </div>
        <div class="carousel-column">
          <h3 id="chapter-title">Chapter Details</h3>
          <p id="slide-info">Slide <span id="slide-current">1</span> of <span id="slide-total">3</span></p>
          <p id="chapter-text" style="margin-bottom:40px;">Select a chapter to see detailed content.</p>
          <div class="slide-indicators" id="slide-indicators"></div>
          <div class="slide-controls">
            <button aria-label="Previous Slide" onclick="prevSlide()">&#10094;</button>
            <button aria-label="Next Slide" onclick="nextSlide()">&#10095;</button>
          </div>
        </div>
        <div class="chat-column">
          <h3>Ask AI about this chapter</h3>
          <textarea id="intro-ai-question" placeholder="Ask a question..."></textarea>
          <button style="margin-top:10px;" onclick="askIntroAI()">Send</button>
          <div id="intro-ai-response" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <!-- AI COACH SECTION -->
    <div id="ai_coach" class="section hidden">
      <h2>AI Coach</h2>
      <div class="ai-coach-wrapper">
        <div class="ai-coach-card">
          <div class="coach-messages" id="coach-messages"></div>
          <div class="coach-input-area">
            <textarea id="ai-question" rows="2" placeholder="Ask a question about RLC..."></textarea>
            <button onclick="askAI()">Send</button>
            <button class="coach-voice-btn" onclick="startVoiceInputAiCoach()" aria-label="Voice Input"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- PROJECT ADMIN SECTION (Admin functions for project assignments) -->
    <div id="project_admin" class="section hidden">
      <h2>Project Admin</h2>
      <p>Manage project assignments and access control on a per-project basis.</p>
      <div style="margin-bottom:10px;">
        <label for="pa_project_selector"><strong>Select Project for Admin:</strong></label><br>
        <select id="pa_project_selector" onchange="refreshProjectAssignmentList()" style="width:300px;">
          <option value="">--Select a Project--</option>
        </select>
      </div>
      <div id="pa_assigned_users">
        <h3>Assigned Users</h3>
        <ul id="pa_user_list" style="list-style:none; padding-left:0;"></ul>
      </div>
      <div style="margin-top:20px;">
        <h3>Add User to Project</h3>
        <label for="pa_user_select">Select User:</label>
        <select id="pa_user_select" style="width:300px;">
          <option value="">--Select User--</option>
        </select>
        <label for="pa_user_role">Role:</label>
        <select id="pa_user_role">
          <option value="viewer">Viewer</option>
          <option value="standard">Standard User</option>
          <option value="project_admin">Project Admin</option>
          <option value="account_admin">Account Admin</option>
        </select>
        <button onclick="addUserToProject()">Add User to Project</button>
      </div>
    </div>

    <!-- ACCOUNT ADMIN SECTION (Admin functions for user management) -->
    <div id="account_admin" class="section hidden">
      <h2>Account Admin</h2>
      <p>Create, edit, or delete user accounts. Fill in the details below:</p>
      <div style="margin-bottom:10px;">
        <label for="new-username"><strong>Email:</strong></label><br>
        <input type="text" id="new-username" style="width:300px;" placeholder="jane.doe@example.com" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="new-firstname"><strong>First Name:</strong></label><br>
        <input type="text" id="new-firstname" style="width:300px;" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="new-lastname"><strong>Last Name:</strong></label><br>
        <input type="text" id="new-lastname" style="width:300px;" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="user-role"><strong>Role:</strong></label><br>
        <select id="user-role">
          <option value="viewer">Viewer</option>
          <option value="standard">Standard User</option>
          <option value="project_admin">Project Admin</option>
          <option value="account_admin">Account Admin</option>
        </select>
      </div>
      <button onclick="createUser()">Create User</button>
      <h3 style="margin-top:20px;">Existing Users</h3>
      <ul id="user-list" style="list-style:none; padding-left:0;"></ul>
    </div>

    <!-- CORE HYPOTHESIS GUIDE SECTION -->
    <div id="core_hypothesis" class="section hidden">
      <h2>Core Hypothesis Guide</h2>
      <p>Upload an image for your Core Hypothesis, then get text suggestions from our “Agentic Guide” to refine your hypothesis. You can edit or “Remix” these suggestions, and once you save a final version, it becomes uneditable until you delete it.</p>
      <div style="margin-bottom:10px;">
        <label for="hypothesis-image-upload"><strong>Upload an Image:</strong></label>
        <input type="file" id="hypothesis-image-upload" accept="image/*" onchange="handleImageUpload(event)" />
      </div>
      <div id="hypothesis-image-display" style="margin-top:10px; border:1px solid #ddd; padding:5px; min-height:150px;">
        <!-- Uploaded image will be displayed here -->
      </div>
      <div id="hypothesis-suggestion-area" style="margin-top:10px;">
        <h3>Agentic Guide Suggestion</h3>
        <textarea id="hypothesis-suggestion" rows="4" style="width:100%;" placeholder="Your AI suggestion will appear here..."></textarea>
        <div style="margin-top:10px; display:flex; gap:10px;">
          <button onclick="remixHypothesis()">Remix Suggestion</button>
          <button onclick="saveFinalHypothesis()">Save Final Version</button>
          <button onclick="deleteFinalHypothesis()">Delete Final Hypothesis</button>
        </div>
      </div>
      <div id="final-hypothesis-display" style="margin-top:20px;">
        <!-- Final hypothesis text will be displayed here -->
      </div>
    </div>

    <!-- PROJECT PLAN SECTION -->
    <div id="project_plan" class="section hidden">
      <h2>Project Plan</h2>
      <div class="toggle-view">
        <button onclick="createNewIE()">Add IE</button>
        <label style="margin-left: 20px;">
          <input type="radio" name="planView" value="board" onclick="showPlanView('board')" checked />
          Board View
        </label>
        <label style="margin-left: 20px;">
          <input type="radio" name="planView" value="flow" onclick="showPlanView('flow')" />
          Flow View
        </label>
      </div>
      <div id="board-container" class="board-container"></div>
      <div id="flow-container" class="diagram-container hidden"></div>
    </div>

    <!-- REPORT WRITER SECTION -->
    <div id="report_writer" class="section hidden">
      <h2>Report Writer</h2>
      <p>Select a report to edit:</p>
      <select id="report-selection" onchange="loadReportTemplate()">
        <option value="">--Choose a Report--</option>
        <option value="KD 01 - Decision Strategy">KD 01 - Decision Strategy</option>
        <option value="KG 01-01 - Latency in Sensor Data">KG 01-01 - Latency in Sensor Data</option>
        <option value="KG 01-02 - Communication Protocols">KG 01-02 - Communication Protocols</option>
        <option value="KD 02 - Edge Processing Implementation">KD 02 - Edge Processing Implementation</option>
        <option value="KG 02-01 - Compute Efficiency on Edge">KG 02-01 - Compute Efficiency on Edge</option>
        <option value="KG 02-02 - Security in Edge Nodes">KG 02-02 - Security in Edge Nodes</option>
      </select>
      <div class="report-layout">
        <div class="report-chat">
          <h3>Chat Assistant</h3>
          <div class="chat-messages" id="report-chat-response">
            <div class="chat-message ai-message">
              <strong>AI:</strong> Welcome to the RLC report writing assistant. I'm an AI designed 
              to help you complete reports more quickly. I won't write anything for you, but I will 
              help you quickly repackage your thoughts into well-structured reports. You have a few 
              options to get started:
              <br><br>
              1. You can fill in the report on screen.<br>
              2. You can chat with me and give me instructions to fill it in.<br>
              3. You can use the voice assistant and tell me everything you know about this report; 
              then I will organize the information.<br><br>
              At the very end you can click "Evaluate Report" and I can help guide you on any missing 
              information. You can also check your report against older reports from other projects 
              by clicking "Check Archive".
            </div>
          </div>
          <div class="chat-input-area">
            <textarea id="report-chat-input" placeholder="Type a message..."></textarea>
            <button onclick="generateReportChat()">Send</button>
            <button class="voice-btn" onclick="startVoiceInputReport()" aria-label="Voice Input"></button>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px;">
            <button onclick="checkReportArchive()">Check Archive</button>
            <button onclick="evaluateReport()">Evaluate Report</button>
          </div>
        </div>
        <div class="report-preview" id="report-preview-section">
          <h3>Report Preview</h3>
          <div class="report-buttons">
            <button onclick="exportPowerPoint()">Export PPT</button>
            <button onclick="exportPDF()">Export PDF</button>
            <button onclick="saveReportEdits()">Save Edits</button>
            <button onclick="lockAndComplete()">Lock &amp; Mark Complete</button>
          </div>
          <div id="report-form-container" style="margin-top:10px;">
            <!-- Dynamic KD/KG form will appear here -->
          </div>
        </div>
      </div>
    </div>

    <!-- ARCHIVE SECTION -->
    <div id="archive" class="section hidden">
      <h2>Archive</h2>
      <p>Upload and manage past reports. Compare current reports against archived documents.</p>
      <input type="file" multiple />
      <button onclick="alert('Uploading files...')">Upload</button>
      <p><strong>Available Reports:</strong></p>
      <div class="folder" onclick="toggleFolder('project1')">▶ IoT Project</div>
      <ul id="project1" class="hidden">
        <li class="file">
          KD 01 - Sensor Integration Strategy
          <button onclick="deleteFile(this)">Delete</button>
        </li>
        <li class="file">
          KG 01-01 - Latency in Sensor Data
          <button onclick="deleteFile(this)">Delete</button>
        </li>
        <li class="file">
          KG 01-02 - Communication Protocols
          <button onclick="deleteFile(this)">Delete</button>
        </li>
      </ul>
    </div>

    <!-- ADMIN SECTIONS DIVIDER (placed below Archive) -->
    <div class="divider"></div>

    <!-- PROJECT ADMIN and ACCOUNT ADMIN sections are now below Archive -->

    <!-- PROJECT ADMIN SECTION (repeated for admin purposes) -->
    <div id="project_admin" class="section hidden">
      <h2>Project Admin</h2>
      <p>Manage project assignments and per‑project access control.</p>
      <div style="margin-bottom:10px;">
        <label for="pa_project_selector"><strong>Select Project for Admin:</strong></label><br>
        <select id="pa_project_selector" onchange="refreshProjectAssignmentList()" style="width:300px;">
          <option value="">--Select a Project--</option>
        </select>
      </div>
      <div id="pa_assigned_users">
        <h3>Assigned Users</h3>
        <ul id="pa_user_list" style="list-style:none; padding-left:0;"></ul>
      </div>
      <div style="margin-top:20px;">
        <h3>Add User to Project</h3>
        <label for="pa_user_select">Select User:</label>
        <select id="pa_user_select" style="width:300px;">
          <option value="">--Select User--</option>
        </select>
        <label for="pa_user_role">Role:</label>
        <select id="pa_user_role">
          <option value="viewer">Viewer</option>
          <option value="standard">Standard User</option>
          <option value="project_admin">Project Admin</option>
          <option value="account_admin">Account Admin</option>
        </select>
        <button onclick="addUserToProject()">Add User to Project</button>
      </div>
    </div>

    <!-- ACCOUNT ADMIN SECTION -->
    <div id="account_admin" class="section hidden">
      <h2>Account Admin</h2>
      <p>Create, edit, or delete user accounts. Provide details for each user below:</p>
      <div style="margin-bottom:10px;">
        <label for="new-username"><strong>Email:</strong></label><br>
        <input type="text" id="new-username" style="width:300px;" placeholder="jane.doe@example.com" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="new-firstname"><strong>First Name:</strong></label><br>
        <input type="text" id="new-firstname" style="width:300px;" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="new-lastname"><strong>Last Name:</strong></label><br>
        <input type="text" id="new-lastname" style="width:300px;" />
      </div>
      <div style="margin-bottom:10px;">
        <label for="user-role"><strong>Role:</strong></label><br>
        <select id="user-role">
          <option value="viewer">Viewer</option>
          <option value="standard">Standard User</option>
          <option value="project_admin">Project Admin</option>
          <option value="account_admin">Account Admin</option>
        </select>
      </div>
      <button onclick="createUser()">Create User</button>
      <h3 style="margin-top:20px;">Existing Users</h3>
      <ul id="user-list" style="list-style:none; padding-left:0;"></ul>
    </div>
  </div>

  <!-- SIDE DRAWER FOR KD -->
  <div id="side-drawer" class="side-drawer">
    <div class="side-drawer-header">
      <h3 id="drawer-title">Edit KD</h3>
      <button class="close-btn" onclick="closeDrawer()">X</button>
    </div>
    <div class="drawer-field">
      <label for="kd-title">KD Title</label>
      <input type="text" id="kd-title" />
    </div>
    <div class="drawer-field">
      <label for="kd-desc">Description</label>
      <textarea id="kd-desc"></textarea>
    </div>
    <div class="drawer-field">
      <label for="kd-ie">Integration Event</label>
      <select id="kd-ie"></select>
    </div>
    <div class="drawer-field">
      <label>Knowledge Gaps</label>
      <div id="kg-list" class="kg-list"></div>
      <button class="add-kg-btn" onclick="addKG()">Add KG</button>
    </div>
    <button style="margin-top: 20px;" onclick="saveKD()">Save</button>
  </div>

  <script>
    /***************************************************
     * SIDEBAR TOGGLE
     ***************************************************/
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    /***************************************************
     * PROJECT DATA
     ***************************************************/
    let projects = [
      { id: "P1", name: "Project A" },
      { id: "P2", name: "Project B" },
      { id: "P3", name: "Project C" }
    ];
    let currentProject = null;

    // Populate project selector (for general use)
    function populateProjectSelector() {
      const sel = document.getElementById('project-selector');
      if (!sel) return;
      projects.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.text = p.name;
        sel.appendChild(opt);
      });

      // Also populate the Project Admin selector
      const paSel = document.getElementById('pa_project_selector');
      if (paSel) {
        projects.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.text = p.name;
          paSel.appendChild(opt);
        });
      }
    }

    function handleProjectSelect() {
      const sel = document.getElementById('project-selector');
      currentProject = sel.value;
      if (currentProject) {
        console.log("Selected project:", currentProject);
        // Update UI as needed for project-specific operations
      }
    }

    /***************************************************
     * PROJECT ADMIN FUNCTIONS
     ***************************************************/
    // Simulated project assignments: mapping project id to assigned users
    let projectAssignments = {
      "P1": [
        { username: "alice@example.com", role: "viewer" },
        { username: "bob@example.com", role: "project_admin" }
      ],
      "P2": [],
      "P3": []
    };

    function refreshProjectAssignmentList() {
      const paSel = document.getElementById("pa_project_selector");
      const projectId = paSel.value;
      const userList = document.getElementById("pa_user_list");
      userList.innerHTML = "";
      if (!projectId || !projectAssignments[projectId]) return;

      projectAssignments[projectId].forEach((assignment, index) => {
        const li = document.createElement("li");
        li.style.marginBottom = "5px";
        li.innerHTML = `${assignment.username} - Role: 
          <select onchange="updateProjectUserRole(${index}, this.value)" id="pa_role_${index}">
            <option value="viewer" ${assignment.role==="viewer"?"selected":""}>Viewer</option>
            <option value="standard" ${assignment.role==="standard"?"selected":""}>Standard User</option>
            <option value="project_admin" ${assignment.role==="project_admin"?"selected":""}>Project Admin</option>
            <option value="account_admin" ${assignment.role==="account_admin"?"selected":""}>Account Admin</option>
          </select>
          <button onclick="removeUserFromProject(${index})">Remove</button>`;
        userList.appendChild(li);
      });

      // Also populate the user selector for adding users (exclude already assigned)
      const paUserSel = document.getElementById("pa_user_select");
      paUserSel.innerHTML = `<option value="">--Select User--</option>`;
      users.forEach(u => {
        // Check if user is already assigned in this project
        const assigned = projectAssignments[projectId].find(a => a.username === u.username);
        if (!assigned) {
          const opt = document.createElement("option");
          opt.value = u.username;
          opt.text = `${u.firstName} ${u.lastName} (${u.username})`;
          paUserSel.appendChild(opt);
        }
      });
    }

    function updateProjectUserRole(index, newRole) {
      const paSel = document.getElementById("pa_project_selector");
      const projectId = paSel.value;
      if (projectAssignments[projectId] && projectAssignments[projectId][index]) {
        projectAssignments[projectId][index].role = newRole;
      }
    }

    function removeUserFromProject(index) {
      const paSel = document.getElementById("pa_project_selector");
      const projectId = paSel.value;
      if (projectAssignments[projectId]) {
        projectAssignments[projectId].splice(index, 1);
        refreshProjectAssignmentList();
      }
    }

    function addUserToProject() {
      const paSel = document.getElementById("pa_project_selector");
      const projectId = paSel.value;
      if (!projectId) {
        alert("Please select a project first.");
        return;
      }
      const userSel = document.getElementById("pa_user_select");
      const username = userSel.value;
      if (!username) {
        alert("Please select a user to add.");
        return;
      }
      const role = document.getElementById("pa_user_role").value;
      if (!projectAssignments[projectId]) {
        projectAssignments[projectId] = [];
      }
      projectAssignments[projectId].push({ username, role });
      refreshProjectAssignmentList();
    }

    /***************************************************
     * ACCOUNT ADMIN FUNCTIONS
     ***************************************************/
    // Updated users now include firstName and lastName
    let users = [
      { username: "alice@example.com", firstName: "Alice", lastName: "Smith", role: "viewer" },
      { username: "bob@example.com", firstName: "Bob", lastName: "Johnson", role: "project_admin" }
    ];

    function createUser() {
      const username = document.getElementById("new-username").value.trim();
      const firstName = document.getElementById("new-firstname").value.trim();
      const lastName = document.getElementById("new-lastname").value.trim();
      const role = document.getElementById("user-role").value;
      if (!username || !firstName || !lastName) {
        alert("Please enter email, first name, and last name.");
        return;
      }
      users.push({ username, firstName, lastName, role });
      document.getElementById("new-username").value = "";
      document.getElementById("new-firstname").value = "";
      document.getElementById("new-lastname").value = "";
      document.getElementById("user-role").value = "viewer";
      refreshUserList();
    }

    function refreshUserList() {
      const list = document.getElementById("user-list");
      list.innerHTML = "";
      users.forEach((u, index) => {
        const li = document.createElement("li");
        li.style.marginBottom = "5px";
        li.innerHTML = `${u.firstName} ${u.lastName} (${u.username}) - Role: 
          <select onchange="editUserRole(${index}, this.value)" id="ua_role_${index}">
            <option value="viewer" ${u.role==="viewer"?"selected":""}>Viewer</option>
            <option value="standard" ${u.role==="standard"?"selected":""}>Standard User</option>
            <option value="project_admin" ${u.role==="project_admin"?"selected":""}>Project Admin</option>
            <option value="account_admin" ${u.role==="account_admin"?"selected":""}>Account Admin</option>
          </select>
          <button onclick="editUser(${index})">Edit</button>
          <button onclick="deleteUser(${index})">Delete</button>`;
        list.appendChild(li);
      });
    }

    function editUser(index) {
      const u = users[index];
      const newFirstName = prompt("Edit First Name:", u.firstName);
      const newLastName = prompt("Edit Last Name:", u.lastName);
      const newEmail = prompt("Edit Email:", u.username);
      if (newFirstName && newLastName && newEmail) {
        users[index] = { ...u, firstName: newFirstName, lastName: newLastName, username: newEmail };
        refreshUserList();
      }
    }

    function editUserRole(index, newRole) {
      users[index].role = newRole;
    }

    function deleteUser(index) {
      if (confirm("Are you sure you want to delete this user?")) {
        users.splice(index, 1);
        refreshUserList();
      }
    }

    /***************************************************
     * INTRO SLIDES
     ***************************************************/
    let currentChapter = null;
    let currentSlideIndex = 0;
    const slidesData = {
      "Overview": [
        "Slide 1: Introduction to Rapid Learning Cycles",
        "Slide 2: Why RLC matters for product development",
        "Slide 3: Key benefits of iterative learning"
      ],
      "Kick-off Event": [
        "Slide 1: Aligning all stakeholders",
        "Slide 2: Defining key decisions early",
        "Slide 3: Setting expectations for the RLC approach"
      ],
      "Core Hypothesis": [
        "Slide 1: What is a core hypothesis?",
        "Slide 2: Structuring strong hypotheses",
        "Slide 3: Validating and refining the hypothesis"
      ],
      "Learning Cycle Plan": [
        "Slide 1: Defining learning cycles for each Key Decision",
        "Slide 2: Scheduling your cycles",
        "Slide 3: Adapting the plan as new info emerges"
      ],
      "Key Decisions": [
        "Slide 1: Identifying critical decisions",
        "Slide 2: Mapping decisions to knowledge gaps",
        "Slide 3: Decision deadlines and consequences"
      ],
      "Knowledge Gaps": [
        "Slide 1: Uncovering unknowns in your product plan",
        "Slide 2: Prioritizing gaps for learning cycles",
        "Slide 3: Documenting learning outcomes"
      ],
      "Status Meetings": [
        "Slide 1: Structured approach to progress checks",
        "Slide 2: Reviewing Key Decisions",
        "Slide 3: Maintaining momentum and accountability"
      ]
    };

    function showSection(sectionId) {
      document.querySelectorAll(".section").forEach(sec => sec.classList.add("hidden"));
      const section = document.getElementById(sectionId);
      if (section) section.classList.remove("hidden");
      closeDrawer();
      if (sectionId === "project_plan") {
        const boardRadio = document.querySelector("[value='board']");
        if (boardRadio) boardRadio.checked = true;
        showPlanView("board");
      }
    }

    function showChapter(chapter) {
      currentChapter = chapter;
      currentSlideIndex = 0;
      updateSlide();
    }

    function updateSlide() {
      const slides = slidesData[currentChapter] || ["No slides available."];
      const slideCurrent = document.getElementById('slide-current');
      const slideTotal = document.getElementById('slide-total');
      const chapterTitle = document.getElementById('chapter-title');
      const chapterText = document.getElementById('chapter-text');
      const indicators = document.getElementById('slide-indicators');
      if (!slideCurrent || !slideTotal || !chapterTitle || !chapterText || !indicators) return;
      slideCurrent.textContent = currentSlideIndex + 1;
      slideTotal.textContent = slides.length;
      chapterTitle.textContent = currentChapter || "Chapter Details";
      chapterText.textContent = slides[currentSlideIndex] || "N/A";
      indicators.innerHTML = "";
      for (let i = 0; i < slides.length; i++) {
        const dot = document.createElement("span");
        if (i === currentSlideIndex) dot.classList.add("active");
        dot.onclick = () => {
          currentSlideIndex = i;
          updateSlide();
        };
        indicators.appendChild(dot);
      }
    }

    function prevSlide() {
      const slides = slidesData[currentChapter] || [];
      if (currentSlideIndex > 0) {
        currentSlideIndex--;
        updateSlide();
      }
    }

    function nextSlide() {
      const slides = slidesData[currentChapter] || [];
      if (currentSlideIndex < slides.length - 1) {
        currentSlideIndex++;
        updateSlide();
      }
    }

    function askIntroAI() {
      const question = document.getElementById("intro-ai-question")?.value;
      const resp = document.getElementById("intro-ai-response");
      if (!resp) return;
      resp.innerHTML = question && question.trim() ? `<p>AI thinks about: "${question}"</p>` : `<p>Please enter a question.</p>`;
    }

    /***************************************************
     * AI COACH
     ***************************************************/
    function askAI() {
      const question = document.getElementById("ai-question")?.value;
      const coachMsgs = document.getElementById("coach-messages");
      if (!coachMsgs) return;
      if (question && question.trim()) {
        coachMsgs.innerHTML += `<div><strong>You:</strong> ${question}</div>`;
        coachMsgs.scrollTop = coachMsgs.scrollHeight;
        setTimeout(() => {
          coachMsgs.innerHTML += `<div><strong>AI:</strong> I've processed "${question}"</div>`;
          coachMsgs.scrollTop = coachMsgs.scrollHeight;
        }, 600);
      }
    }

    function startVoiceInputAiCoach() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Voice input not supported in this browser.');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-US';
      recognition.onresult = e => {
        document.getElementById("ai-question").value = e.results[0][0].transcript;
      };
      recognition.start();
    }

    /***************************************************
     * CORE HYPOTHESIS GUIDE
     ***************************************************/
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          img.style.maxWidth = "300px";
          img.style.display = "block";
          img.style.marginBottom = "10px";
          document.getElementById("hypothesis-image-display").innerHTML = "";
          document.getElementById("hypothesis-image-display").appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    }

    function remixHypothesis() {
      const suggestionEl = document.getElementById("hypothesis-suggestion");
      if (suggestionEl) {
        suggestionEl.value = "Here is a remixed suggestion from the Agentic Guide... (placeholder)";
      }
    }

    function saveFinalHypothesis() {
      const suggestionEl = document.getElementById("hypothesis-suggestion");
      if (!suggestionEl) return;
      const finalText = suggestionEl.value.trim();
      if (!finalText) {
        alert("Cannot save an empty hypothesis. Please add or remix content first.");
        return;
      }
      document.getElementById("final-hypothesis-display").innerHTML = `<h4>Final Hypothesis</h4><p>${finalText}</p>`;
      suggestionEl.disabled = true;
    }

    function deleteFinalHypothesis() {
      document.getElementById("final-hypothesis-display").innerHTML = "";
      const suggestionEl = document.getElementById("hypothesis-suggestion");
      suggestionEl.disabled = false;
      suggestionEl.value = "";
      document.getElementById("hypothesis-image-display").innerHTML = "";
      document.getElementById("hypothesis-image-upload").value = "";
    }

    /***************************************************
     * PROJECT PLAN
     ***************************************************/
    let IEs = [
      {
        id: "IE1",
        name: "IE1",
        kds: [
          { id: "KD01", title: "Webshop Look & Feel", desc: "Define layout", ie: "IE1", kgs: [] },
          { id: "KD02", title: "Data Creation Strategy", desc: "Plan for data input", ie: "IE1", kgs: [] }
        ]
      },
      {
        id: "IE2",
        name: "IE2",
        kds: [
          { id: "KD03", title: "Data Classifications (TC?)", desc: "Review classification", ie: "IE2", kgs: [] },
          { id: "KD04", title: "Field Set (PIM?)", desc: "Fields needed in system", ie: "IE2", kgs: [] }
        ]
      },
      {
        id: "IE3",
        name: "IE3",
        kds: [
          { id: "KD05", title: "Article Types", desc: "Which articles are loaded?", ie: "IE3", kgs: [] },
          { id: "KD06", title: "Content Display Strategy", desc: "How to show content", ie: "IE3", kgs: [] }
        ]
      }
    ];
    let editingKD = null;

    function showPlanView(viewType) {
      const boardCtn = document.getElementById("board-container");
      const flowCtn = document.getElementById("flow-container");
      boardCtn.classList.add("hidden");
      flowCtn.classList.add("hidden");
      if (viewType === "board") {
        boardCtn.classList.remove("hidden");
        renderBoard();
      } else {
        flowCtn.classList.remove("hidden");
        renderFlow();
      }
    }

    function createNewIE() {
      const ieName = prompt("Enter name for new Integration Event:");
      if (!ieName) return;
      const newIE = { id: "IE" + Math.floor(Math.random() * 10000), name: ieName, kds: [] };
      IEs.push(newIE);
      const boardRadio = document.querySelector("[value='board']");
      if (boardRadio && boardRadio.checked) renderBoard(); else renderFlow();
    }

    function renderBoard() {
      const board = document.getElementById("board-container");
      board.innerHTML = "";
      IEs.forEach(ie => {
        const col = document.createElement("div");
        col.className = "ie-column";
        col.innerHTML = `<h4>${ie.name}</h4>`;
        ie.kds.forEach(kd => {
          const kdCard = document.createElement("div");
          kdCard.className = "kd-card";
          kdCard.innerHTML = `<span>${kd.title}</span><span class="pencil">&#9998;</span>`;
          kdCard.onclick = () => openKDDetails(kd.id);
          col.appendChild(kdCard);
        });
        const addBtn = document.createElement("button");
        addBtn.className = "add-kd-btn";
        addBtn.innerText = "Add KD";
        addBtn.onclick = () => createNewKD(ie.id);
        col.appendChild(addBtn);
        board.appendChild(col);
      });
    }

    function renderFlow() {
      const flowContainer = document.getElementById("flow-container");
      flowContainer.innerHTML = "";
      let xPos = 30, yPos = 40, spacing = 250;
      IEs.forEach((ie, idx) => {
        const ieNode = document.createElement("div");
        ieNode.className = "ie-node";
        ieNode.style.top = yPos + "px";
        ieNode.style.left = xPos + "px";
        ieNode.onclick = (e) => { e.stopPropagation(); openIEDetails(ie.id); };
        ieNode.innerHTML = `<strong>${ie.name}</strong><div class="kd-list"></div>`;
        flowContainer.appendChild(ieNode);
        const kdListElem = ieNode.querySelector(".kd-list");
        ie.kds.forEach(kd => {
          const kdDiv = document.createElement("div");
          kdDiv.className = "kd-item";
          kdDiv.innerText = kd.title;
          kdDiv.onclick = (evt) => { evt.stopPropagation(); openKDDetails(kd.id); };
          kdListElem.appendChild(kdDiv);
        });
        if (idx < IEs.length - 1) {
          const line = document.createElement("div");
          line.className = "diagram-line";
          line.style.top = (yPos + 40) + "px";
          line.style.left = (xPos + 180) + "px";
          line.style.height = "2px";
          line.style.width = (spacing - 180) + "px";
          flowContainer.appendChild(line);
        }
        xPos += spacing;
      });
    }

    function openIEDetails(ieId) {
      alert(`IE details for ${ieId} not implemented.\nUse Board View to add KDs or click a KD in Flow to edit.`);
    }

    /* SIDE DRAWER FOR KD */
    function openDrawer() {
      document.getElementById("side-drawer").classList.add("open");
    }
    function closeDrawer() {
      document.getElementById("side-drawer").classList.remove("open");
      editingKD = null;
    }
    function openKDDetails(kdId) {
      let foundKD = null;
      IEs.forEach(ie => {
        ie.kds.forEach(kd => { if (kd.id === kdId) foundKD = kd; });
      });
      if (!foundKD) return;
      editingKD = foundKD;
      document.getElementById("drawer-title").innerText = `Edit KD: ${foundKD.id}`;
      document.getElementById("kd-title").value = foundKD.title;
      document.getElementById("kd-desc").value = foundKD.desc;
      const ieSelect = document.getElementById("kd-ie");
      ieSelect.innerHTML = "";
      IEs.forEach(ie => {
        const opt = document.createElement("option");
        opt.value = ie.id;
        opt.text = ie.name;
        if (ie.id === foundKD.ie) opt.selected = true;
        ieSelect.appendChild(opt);
      });
      renderKGList(foundKD);
      openDrawer();
    }
    function createNewKD(ieId) {
      editingKD = { id: "KD" + Math.floor(Math.random() * 1000), title: "", desc: "", ie: ieId, kgs: [] };
      document.getElementById("drawer-title").innerText = `Create new KD in ${ieId}`;
      document.getElementById("kd-title").value = "";
      document.getElementById("kd-desc").value = "";
      const ieSelect = document.getElementById("kd-ie");
      ieSelect.innerHTML = "";
      IEs.forEach(ie => {
        const opt = document.createElement("option");
        opt.value = ie.id;
        opt.text = ie.name;
        if (ie.id === ieId) opt.selected = true;
        ieSelect.appendChild(opt);
      });
      renderKGList(editingKD);
      openDrawer();
    }
    function renderKGList(kdObj) {
      const kgListDiv = document.getElementById("kg-list");
      kgListDiv.innerHTML = "";
      kdObj.kgs.forEach((kg, idx) => {
        const div = document.createElement("div");
        div.className = "kg-item";
        div.innerText = kg;
        div.onclick = () => {
          const newVal = prompt("Edit Knowledge Gap:", kg);
          if (newVal != null) { kdObj.kgs[idx] = newVal; renderKGList(kdObj); }
        };
        kgListDiv.appendChild(div);
      });
    }
    function addKG() {
      if (!editingKD) return;
      const newKG = prompt("Enter new Knowledge Gap:");
      if (newKG) { editingKD.kgs.push(newKG); renderKGList(editingKD); }
    }
    function saveKD() {
      const kdTitle = document.getElementById("kd-title").value;
      const kdDesc = document.getElementById("kd-desc").value;
      const kdIE = document.getElementById("kd-ie").value;
      editingKD.title = kdTitle;
      editingKD.desc = kdDesc;
      if (editingKD.ie !== kdIE) { moveKDToIE(editingKD, editingKD.ie, kdIE); }
      closeDrawer();
      const boardRadio = document.querySelector("[value='board']");
      if (boardRadio && boardRadio.checked) renderBoard(); else renderFlow();
    }
    function moveKDToIE(kdObj, oldIE, newIE) {
      const oldIEObj = IEs.find(i => i.id === oldIE);
      if (oldIEObj) { oldIEObj.kds = oldIEObj.kds.filter(k => k.id !== kdObj.id); }
      const newIEObj = IEs.find(i => i.id === newIE);
      if (newIEObj) { kdObj.ie = newIE; newIEObj.kds.push(kdObj); }
    }

    /***************************************************
     * ARCHIVE
     ***************************************************/
    function toggleFolder(folderId) {
      document.getElementById(folderId).classList.toggle("hidden");
    }
    function deleteFile(element) {
      element.parentElement.remove();
    }

    /***************************************************
     * REPORT WRITER
     ***************************************************/
    function loadReportTemplate() {
      const val = document.getElementById('report-selection').value.trim();
      if (!val) return;
      const container = document.getElementById('report-form-container');
      container.innerHTML = "";
      if (val.startsWith("KD")) {
        const matches = val.match(/^KD\s+(\S+)\s+-/);
        const kdNumber = matches ? matches[1] : "??";
        container.innerHTML = getKDTemplateHtml(kdNumber);
      } else if (val.startsWith("KG")) {
        const matches = val.match(/^KG\s+(\S+)\s+-/);
        const kgNumber = matches ? matches[1] : "??";
        container.innerHTML = getKGTemplateHtml(kgNumber);
      }
    }
    function getKDTemplateHtml(kdNumber) {
      return `
      <div class="template-grid" style="grid-template-areas:
        'bannerLeft  bannerRight'
        'kdBox       learned'
        'purpose     learned'
        'doneBox     recBox';">
        <div class="banner-left banner-left-kd" style="grid-area: bannerLeft;">
          <strong>Key Decision (title can have keywords):</strong><br/>
          Owner: <input type="text" style="width:120px;"><br/>
          Decision Maker: <input type="text" style="width:120px;"><br/>
          Integration Event: <input type="text" style="width:120px;">
        </div>
        <div class="banner-right banner-right-kd" style="grid-area: bannerRight;">
          <div style="font-size:0.9em;">PROJECT NAME<br/>Key Decision #${kdNumber}</div>
        </div>
        <div class="template-box" style="grid-area: kdBox;">
          <h4>The Key Decision</h4>
          <textarea></textarea>
        </div>
        <div class="template-box" style="grid-area: purpose;">
          <h4>The Purpose</h4>
          <p style="font-size:0.9em;">(link back to the project’s Objectives)</p>
          <textarea></textarea>
        </div>
        <div class="template-box template-large" style="grid-area: learned;">
          <h4>What We Have Learned – summary of all Knowledge Gaps</h4>
          <textarea style="height:120px;"></textarea>
        </div>
        <div class="template-box template-large" style="grid-area: doneBox;">
          <h4>What We Have Done</h4>
          <p style="font-size:0.9em;">summary of work to close knowledge gaps and build stakeholder alignment</p>
          <textarea style="height:120px;"></textarea>
        </div>
        <div class="template-box template-large" style="grid-area: recBox;">
          <h4>What We Recommend / What We Have Decided</h4>
          <textarea style="height:80px;"></textarea>
        </div>
      </div>
      `;
    }
    function getKGTemplateHtml(kgNumber) {
      return `
      <div class="template-grid" style="grid-template-areas:
        'bannerLeft bannerRight'
        'question   learned'
        'purpose    learned'
        'doneBox    recBox';">
        <div class="banner-left" style="grid-area: bannerLeft;">
          <strong>Knowledge Gap: </strong>
          <input type="text" placeholder="KG Title..." style="width:80%;"><br/>
          Owner: <input type="text" style="width:150px;"><br/>
          Contributors: <input type="text" style="width:200px;"><br/>
          Learning Cycle: <input type="text" style="width:100px;">
        </div>
        <div class="banner-right" style="grid-area: bannerRight;">
          <div style="font-size:0.9em;">PROJECT NAME<br/>Knowledge Gap #${kgNumber}</div>
          <div style="margin-top:5px;">In Progress</div>
        </div>
        <div class="template-box" style="grid-area: question;">
          <h4>The Question to Answer</h4>
          <textarea></textarea>
        </div>
        <div class="template-box template-large" style="grid-area: learned;">
          <h4>What We Have Learned</h4>
          <textarea style="height:120px;"></textarea>
        </div>
        <div class="template-box" style="grid-area: purpose;">
          <h4>The Purpose</h4>
          <p style="font-size:0.9em;">(link back to the Knowledge Gap’s Key Decision)</p>
          <textarea></textarea>
        </div>
        <div class="template-box template-large" style="grid-area: doneBox;">
          <h4>What We Have Done</h4>
          <p style="font-size:0.9em;">summary of your plan to close the KG</p>
          <textarea style="height:120px;"></textarea>
        </div>
        <div class="template-box template-large" style="grid-area: recBox;">
          <h4>Recommendations and Next Steps</h4>
          <textarea style="height:80px;"></textarea>
        </div>
      </div>
      `;
    }

    /***************************************************
     * REPORT WRITER CHAT
     ***************************************************/
    function generateReportChat() {
      const userInput = document.getElementById('report-chat-input').value.trim();
      const msgDiv = document.getElementById('report-chat-response');
      if (!userInput || !msgDiv) return;
      msgDiv.innerHTML += `<div><strong>You:</strong> ${userInput}</div>`;
      msgDiv.scrollTop = msgDiv.scrollHeight;
      setTimeout(() => {
        msgDiv.innerHTML += `<div><strong>AI:</strong> I see you typed "${userInput}".</div>`;
        msgDiv.scrollTop = msgDiv.scrollHeight;
      }, 600);
    }

    function startVoiceInputReport() {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Voice input not supported in this browser.');
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-US';
      recognition.onresult = e => {
        document.getElementById("report-chat-input").value = e.results[0][0].transcript;
      };
      recognition.start();
    }

    function checkReportArchive() {
      alert('Checking the current report against the archive (placeholder).');
    }
    function evaluateReport() {
      alert('Evaluating the current report (placeholder).');
    }
    function exportPowerPoint() {
      alert('Exporting to PowerPoint (placeholder).');
    }
    function exportPDF() {
      alert('Exporting to PDF (placeholder).');
    }
    function saveReportEdits() {
      alert('Saving the current report (placeholder).');
    }
    let reportLocked = false;
    function lockAndComplete() {
      alert('This report is now locked & marked complete. No further edits allowed (client-side).');
      reportLocked = true;
      const container = document.getElementById('report-form-container');
      if (container) {
        container.querySelectorAll('input, textarea, select, button').forEach(elem => {
          elem.disabled = true;
        });
      }
    }

    /***************************************************
     * ON WINDOW LOAD
     ***************************************************/
    window.onload = function() {
      populateProjectSelector();
      refreshProjectList();
      refreshUserList();
    };
  </script>
</body>
</html>